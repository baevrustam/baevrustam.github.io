<html>
<head></head>
<body>


<?php
echo "ghbdtn h";
#Ěŕńńčâ ń ďŕđŕěĺňđŕěč, ęîňîđűĺ íóćíî ďĺđĺäŕňü ěĺňîäîě POST ę API ńčńňĺěű
$user=array(
 'USER_LOGIN'=>'bestcleaning770@gmail.com', #Âŕř ëîăčí (ýëĺęňđîííŕ˙ ďî÷ňŕ)
 'USER_HASH'=>'09a4c0e29bd630d69e3b6273eca405edaa878f7d' #Őýř äë˙ äîńňóďŕ ę API (ńěîňđčňĺ â ďđîôčëĺ ďîëüçîâŕňĺë˙)
);
$subdomain='bestcleaning770'; #Íŕř ŕęęŕóíň - ďîääîěĺí

#Ôîđěčđóĺě ńńűëęó äë˙ çŕďđîńŕ
$auth_link='https://'.$subdomain.'.amocrm.ru/private/api/auth.php?type=json';
$lead_link='https://'.$subdomain.'.amocrm.ru/api/v2/leads?status=22375147';
$contact_link='https://'.$subdomain.'.amocrm.ru/api/v2/contacts/';
$note_link='https://'.$subdomain.'.amocrm.ru/api/v2/notes';
/* Íŕě íĺîáőîäčěî číčöččđîâŕňü çŕďđîń ę ńĺđâĺđó. Âîńďîëüçóĺěń˙ áčáëčîňĺęîé cURL (ďîńňŕâë˙ĺňń˙ â ńîńňŕâĺ PHP). Âű ňŕęćĺ
ěîćĺňĺ
čńďîëüçîâŕňü č ęđîńńďëŕňôîđěĺííóţ ďđîăđŕěěó cURL, ĺńëč âű íĺ ďđîăđŕěěčđóĺňĺ íŕ PHP. */
	$auth_curl=curl_init(); #Ńîőđŕí˙ĺě äĺńęđčďňîđ ńĺŕíńŕ cURL
#Óńňŕíŕâëčâŕĺě íĺîáőîäčěűĺ îďöčč äë˙ ńĺŕíńŕ cURL
	curl_setopt($auth_curl,CURLOPT_RETURNTRANSFER,true);
	curl_setopt($auth_curl,CURLOPT_USERAGENT,'amoCRM-API-client/1.0');
	curl_setopt($auth_curl,CURLOPT_URL,$auth_link);
	curl_setopt($auth_curl,CURLOPT_CUSTOMREQUEST,'POST');
	curl_setopt($auth_curl,CURLOPT_POSTFIELDS,json_encode($user));
	curl_setopt($auth_curl,CURLOPT_HTTPHEADER,array('Content-Type: application/json'));
	curl_setopt($auth_curl,CURLOPT_HEADER,false);
	curl_setopt($auth_curl,CURLOPT_COOKIEFILE,dirname(__FILE__).'/cookie.txt'); #PHP>5.3.6 dirname(__FILE__) -> __DIR__
	curl_setopt($auth_curl,CURLOPT_COOKIEJAR,dirname(__FILE__).'/cookie.txt'); #PHP>5.3.6 
	curl_setopt($auth_curl,CURLOPT_SSL_VERIFYPEER,false);
	curl_setopt($auth_curl,CURLOPT_SSL_VERIFYHOST,false);
	#curl_setopt($auth_curl,CURLOPT_VERBOSE,true);
	$auth=curl_exec($auth_curl); #Číčöččđóĺě çŕďđîń ę API č ńîőđŕí˙ĺě îňâĺň â ďĺđĺěĺííóţ
	$auth_code=curl_getinfo($auth_curl,CURLINFO_HTTP_CODE); #Ďîëó÷čě HTTP-ęîä îňâĺňŕ ńĺđâĺđŕ	
	curl_close($auth_curl); #Çŕâĺđřŕĺě ńĺŕíń cURL AUTH	
				
				$lead_curl=curl_init();
				/* Óńňŕíŕâëčâŕĺě íĺîáőîäčěűĺ îďöčč äë˙ ńĺŕíńŕ cURL */
				curl_setopt($lead_curl,CURLOPT_RETURNTRANSFER,true);
				curl_setopt($lead_curl,CURLOPT_USERAGENT,'amoCRM-API-client/1.0');
				curl_setopt($lead_curl,CURLOPT_URL,$lead_link);
				curl_setopt($lead_curl,CURLOPT_HEADER,false);
				
				curl_setopt($lead_curl,CURLOPT_COOKIEFILE,dirname(__FILE__).'/cookie.txt'); #PHP>5.3.6 dirname(__FILE__) -> __DIR__
				curl_setopt($lead_curl,CURLOPT_COOKIEJAR,dirname(__FILE__).'/cookie.txt'); #PHP>5.3.6 
				
				curl_setopt($lead_curl,CURLOPT_SSL_VERIFYPEER,false);
				curl_setopt($lead_curl,CURLOPT_SSL_VERIFYHOST,false);
				curl_setopt($lead_curl,CURLOPT_VERBOSE,true);
				/* Âű ňŕęćĺ ěîćĺňĺ ďĺđĺäŕňü äîďîëíčňĺëüíűé HTTP-çŕăîëîâîę IF-MODIFIED-SINCE, â ęîňîđîě óęŕçűâŕĺňń˙ äŕňŕ â ôîđěŕňĺ D, d M Y
				H:i:s. Ďđč
				ďĺđĺäŕ÷ĺ ýňîăî çŕăîëîâęŕ áóäóň âîçâđŕůĺíű ńäĺëęč, čçěĺí¸ííűĺ ďîçćĺ ýňîé äŕňű. */
				curl_setopt($lead_curl,CURLOPT_HTTPHEADER,array('IF-MODIFIED-SINCE: Mon, 01 Aug 2013 07:07:23'));
				/* Âűďîëí˙ĺě çŕďđîń ę ńĺđâĺđó. */
				$lead_out=curl_exec($lead_curl); #Číčöččđóĺě çŕďđîń ę API č ńîőđŕí˙ĺě îňâĺň â ďĺđĺěĺííóţ
				$lead_code=curl_getinfo($lead_curl,CURLINFO_HTTP_CODE);
				curl_close($lead_curl); #CLOSE LEAD 
							$contact_curl=curl_init(); #Ńîőđŕí˙ĺě äĺńęđčďňîđ ńĺŕíńŕ cURL
							#Óńňŕíŕâëčâŕĺě íĺîáőîäčěűĺ îďöčč äë˙ ńĺŕíńŕ cURL
							curl_setopt($contact_curl,CURLOPT_RETURNTRANSFER,true);
							curl_setopt($contact_curl,CURLOPT_USERAGENT,'amoCRM-API-client/1.0');
							curl_setopt($contact_curl,CURLOPT_URL,$contact_link);
							curl_setopt($contact_curl,CURLOPT_HEADER,false);
							curl_setopt($contact_curl,CURLOPT_COOKIEFILE,dirname(__FILE__).'/cookie.txt'); #PHP>5.3.6 dirname(__FILE__) -> __DIR__
							curl_setopt($contact_curl,CURLOPT_COOKIEJAR,dirname(__FILE__).'/cookie.txt'); #PHP>5.3.6 dirname(__FILE__) -> __DIR__
							curl_setopt($contact_curl,CURLOPT_SSL_VERIFYPEER,0);
							curl_setopt($contact_curl,CURLOPT_SSL_VERIFYHOST,0);
							$contact_out=curl_exec($contact_curl); #Číčöččđóĺě çŕďđîń ę API č ńîőđŕí˙ĺě îňâĺň â ďĺđĺěĺííóţ
							$contact_code=curl_getinfo($contact_curl,CURLINFO_HTTP_CODE);
							curl_close($contact_curl);

/* Ňĺďĺđü ěű ěîćĺě îáđŕáîňŕňü îňâĺň, ďîëó÷ĺííűé îň ńĺđâĺđŕ. Ýňî ďđčěĺđ. Âű ěîćĺňĺ îáđŕáîňŕňü äŕííűĺ ńâîčě ńďîńîáîě. */
$auth_code =(int)$auth_code;

$errors=array(
  301=>'Moved permanently',
  400=>'Bad request',
  401=>'Unauthorized',
  403=>'Forbidden',
  404=>'Not found',
  500=>'Internal server error',
  502=>'Bad gateway',
  503=>'Service unavailable'
);
try
{
  #Ĺńëč ęîä îňâĺňŕ íĺ đŕâĺí 200 čëč 204 - âîçâđŕůŕĺě ńîîáůĺíčĺ îá îřčáęĺ
 if($auth_code!=200 && $auth_code!=204)
    throw new Exception(isset($errors[$auth_code]) ? $errors[$auth_code] : 'Undescribed error',$auth_code);
}
catch(Exception $E)
{
  die('Îřčáęŕ: '.$E->getMessage().PHP_EOL.'Ęîä îřčáęč: '.$E->getCode());
}
/*
 Äŕííűĺ ďîëó÷ŕĺě â ôîđěŕňĺ JSON, ďîýňîěó, äë˙ ďîëó÷ĺíč˙ ÷čňŕĺěűő äŕííűő,
 íŕě ďđčä¸ňń˙ ďĺđĺâĺńňč îňâĺň â ôîđěŕň, ďîí˙ňíűé PHP
 */
/* 					$Auth_Response=json_decode($auth,true);
					$Auth_Response=$Auth_Response['response'];

					if(isset($Auth_Response['auth'])) #Ôëŕă ŕâňîđčçŕöčč äîńňóďĺí â ńâîéńňâĺ "auth"
					 print 'Ŕâňîđčçŕöč˙ ďđîřëŕ óńďĺříî';
					 else
					print 'Ŕâňîđčçŕöč˙ íĺ óäŕëŕńü';
 *//*===============================LEAD=======================*/

$lead_code=(int)$lead_code;

$errors=array(
  301=>'Moved permanently',
  400=>'Bad request',
  401=>'Unauthorized',
  403=>'Forbidden',
  404=>'Not found',
  500=>'Internal server error',
  502=>'Bad gateway',
  503=>'Service unavailable'
);
try
{
  /* Ĺńëč ęîä îňâĺňŕ íĺ đŕâĺí 200 čëč 204 - âîçâđŕůŕĺě ńîîáůĺíčĺ îá îřčáęĺ */
  if($lead_code!=200 && $lead_code!=204) {
    throw new Exception(isset($errors[$lead_code]) ? $errors[$lead_code] : 'Undescribed error',$lead_code);
  }
}
catch(Exception $E)
{
  die('Îřčáęŕ: '.$E->getMessage().PHP_EOL.'Ęîä îřčáęč: '.$E->getCode());
}
/*
 Äŕííűĺ ďîëó÷ŕĺě â ôîđěŕňĺ JSON, ďîýňîěó, äë˙ ďîëó÷ĺíč˙ ÷čňŕĺěűő äŕííűő,
 íŕě ďđčä¸ňń˙ ďĺđĺâĺńňč îňâĺň â ôîđěŕň, ďîí˙ňíűé PHP

 */

 $Lead_Response=json_decode($lead_out,true);

 	
 $Lead_Response_Items=$Lead_Response['_embedded']['items']; #(0.1.2.3....10..z)
 for($i = 0; $i < count($Lead_Response_Items); ++$i) {
    $Prn = $Lead_Response_Items[$i]['id'] ;
print_r ("ńäĺëęŕ".$Prn."\n");
$c=$c+1;

#=================NOTES==========================================================
$note_data = array (
					  'add' =>
					  array (
						0 =>
						array (
						  'element_id' => $Prn,
						  'element_type' => '2',
						  'text' => 'web test',
						  'note_type' => '4'
						  ),
					  ),
					);
				

					$note_curl=curl_init(); #Ńîőđŕí˙ĺě äĺńęđčďňîđ ńĺŕíńŕ cURL
					#Óńňŕíŕâëčâŕĺě íĺîáőîäčěűĺ îďöčč äë˙ ńĺŕíńŕ cURL
					curl_setopt($note_curl,CURLOPT_RETURNTRANSFER,true);
					curl_setopt($note_curl,CURLOPT_USERAGENT,'amoCRM-API-client/1.0');
					curl_setopt($note_curl,CURLOPT_URL,$note_link);
					curl_setopt($note_curl,CURLOPT_CUSTOMREQUEST,'POST');
					curl_setopt($note_curl,CURLOPT_POSTFIELDS,json_encode($note_data));
					curl_setopt($note_curl,CURLOPT_HTTPHEADER,array('Content-Type: application/json'));
					curl_setopt($note_curl,CURLOPT_HEADER,false);
					curl_setopt($note_curl,CURLOPT_COOKIEFILE,dirname(__FILE__).'/cookie.txt'); #PHP>5.3.6 dirname(__FILE__) -> __DIR__
					curl_setopt($note_curl,CURLOPT_COOKIEJAR,dirname(__FILE__).'/cookie.txt'); #PHP>5.3.6 dirname(__FILE__) -> __DIR__
					curl_setopt($note_curl,CURLOPT_SSL_VERIFYPEER,0);
					curl_setopt($note_curl,CURLOPT_SSL_VERIFYHOST,0);
					$note_out=curl_exec($note_curl); #Číčöččđóĺě çŕďđîń ę API č ńîőđŕí˙ĺě îňâĺň â ďĺđĺěĺííóţ
					$note_code=curl_getinfo($note_curl,CURLINFO_HTTP_CODE);
					/* Ňĺďĺđü ěű ěîćĺě îáđŕáîňŕňü îňâĺň, ďîëó÷ĺííűé îň ńĺđâĺđŕ. Ýňî ďđčěĺđ. Âű ěîćĺňĺ îáđŕáîňŕňü äŕííűĺ ńâîčě ńďîńîáîě. */
					$note_code=(int)$note_code;
					$errors=array(
					  301=>'Moved permanently',
					  400=>'Bad request',
					  401=>'Unauthorized',
					  403=>'Forbidden',
					  404=>'Not found',
					  500=>'Internal server error',
					  502=>'Bad gateway',
					  503=>'Service unavailable'
					);
					try
					{
					  #Ĺńëč ęîä îňâĺňŕ íĺ đŕâĺí 200 čëč 204 - âîçâđŕůŕĺě ńîîáůĺíčĺ îá îřčáęĺ
					 if($note_code!=200 && $note_code!=204)
						throw new Exception(isset($errors[$note_code]) ? $errors[$note_code] : 'Undescribed error',$note_code);
					}
					catch(Exception $E)
					{
					  die('Îřčáęŕ: '.$E->getMessage().PHP_EOL.'Ęîä îřčáęč: '.$E->getCode());
					}
 $note_Response=json_decode($note_out,true);
 print_r ($note_Response);
print_r ($note_data);





	}	
	print "âńĺăî ńäĺëîę: ".$c;
 $Lead_Response_Contacts = $Lead_Response_Items['contacts']['id']; #(0.1.2.3....10..z)
 
#print_r($Lead_Response);


#============================================CONTACTS===============================

$contact_code =(int)$contact_code;

$errors=array(
  301=>'Moved permanently',
  400=>'Bad request',
  401=>'Unauthorized',
  403=>'Forbidden',
  404=>'Not found',
  500=>'Internal server error',
  502=>'Bad gateway',
  503=>'Service unavailable'
);
try
{
  #Ĺńëč ęîä îňâĺňŕ íĺ đŕâĺí 200 čëč 204 - âîçâđŕůŕĺě ńîîáůĺíčĺ îá îřčáęĺ
 if($contact_code!=200 && $contact_code!=204)
    throw new Exception(isset($errors[$contact_code]) ? $errors[$contact_code] : 'Undescribed error',$contact_code);
}
catch(Exception $E)
{
  die('Îřčáęŕ: '.$E->getMessage().PHP_EOL.'Ęîä îřčáęč: '.$E->getCode());
}

$Contact_Response=json_decode($contact_out,true);
 $Contact_Response_Items=$Contact_Response['_embedded']['items'];
#print_r ($Contact_Response_Items);



?>

</body>
</html>
